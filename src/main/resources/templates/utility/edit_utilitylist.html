<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default}">
<head>
<meta charset="ISO-8859-1" />
<title>Utility Reports</title>
</head>
<body>
	<div layout:fragment="content">
		<div class="breadcrumbs ace-save-state" id="breadcrumbs">
			<ul class="breadcrumb">
				<li><i class="ace-icon fa fa-home home-icon"></i> <a href="#">Home</a>
				</li>
				<li><a href="/form">Utility Expenses</a></li>
				<li class="active">Edit Utility List</li>
			</ul>
		</div>
		<div class="page-content">
			<div class="row">
				<div class="col-xs-12">
					<!-- PAGE CONTENT BEGINS -->
					<div th:if="${message}">
						<h2 class="alert alert-danger" th:text="${message}" />
					</div>
					<div th:if="${successMessage}">
						<div class="alert alert-success">
							<button type="button" class="close" data-dismiss="alert">
								<i class="ace-icon fa fa-times"></i>
							</button>
							<strong th:text="${successMessage}">Success!</strong> <br />
						</div>
					</div>
				</div>
			</div>
			<div id="showMessage"></div>

			<div class="col-xs-12 col-sm-8 col-sm-offset-2">
				<div class="search-area well well-sm">
					<div class="search-filter-header bg-primary">
						<h5 class="smaller no-margin-bottom">
							<i class="ace-icon fa fa-sliders light-green bigger-130"></i>&nbsp;
							Refine your search
						</h5>
					</div>
					<div class="space-6"></div>
					<fieldset class="form-inline">
						<div class="col-xs-6 col-sm-6">
							<select class="form-control col-xs-6 col-sm-3"
								id="branchName-dropdown" name="branchName"></select>
						</div>
						<div class="col-xs-6 col-sm-6">
							<select class="fiscalYear-dropdown input-large col-xs-6 col-sm-3"
								id="idFiscalYear" name="fiscalYear"></select>
						</div>
					</fieldset>
				</div>
			</div>

			<div th:if="${utilityByFiscal != null}" class="row">
				<div class="col-xs-12">
					<div class="table-responsive">
						<div class="clearfix">
							<div class="pull-right tableTools-container"></div>
						</div>
						<div class="table-header">
							Utility Report &nbsp;&nbsp;<span id="branchValueShow"></span>&nbsp;
							<span id="fiscalValueShow"></span>
						</div>
						<div>
							<table id="dynamic-table"
								class="table table-striped table-bordered table-hover">
								<thead>
									<tr>
										<th width="3%"></th>
										<th width="8%">Fiscal Year</th>
										<th width="10%">Branch</th>
										<th class="hidden-480" width="8%">Month</th>
										<th width="8%">Electricity</th>
										<th width="8%">Fuel (Vehicle- 2 Wheeler)</th>
										<th width="8%">Fuel (Vehicle-4 Wheeler)</th>
										<th width="8%">Fuel (Genset)</th>
										<th width="8%">Telephone</th>
										<th width="8%">Maintenance</th>
										<th width="8%">Others Expenses</th>
										<th class="info" width="10%">Total (Rs.)</th>
										<th width="3%">Edit</th>
										<th width="3%"
											sec:authorize="hasAnyAuthority('ADMIN','HIGHSUPERVISOR','CARDSUPERVISOR')">Delete</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- /.main-content -->
	<th:block layout:fragment="scripts">
		<script>
			$(document).ready(function() {
				$('.select2').css('width', '100%').select2({});
			});
		</script>
		<script>
			function updateParent(control) {
				var dialog = bootbox
						.dialog({
							title : 'Delete Utility!!!',
							message : '<p>Are you sure you want to delete recorded utility data?</p>',
							size : 'md',
							onEscape : true,
							backdrop : true,
							buttons : {
								cancel : {
									label : '<i class="fa fa-times"></i> Cancel',
									className : 'btn-danger pull-right margin-left-10px',
								},
								ok : {
									label : '<i class="fa fa-check"></i> Confirm',
									className : 'btn-info',
									callback : function(result) {
										if (result) {
											$
													.ajax({
														type : 'DELETE',
														url : '/editutilitydata/delete/'
																+ control,
														success : function(
																result) {
															$('#showMessage')
																	.append(
																			"<div class='alert alert-danger'><button type='button' class='close' data-dismiss='alert'><i class='ace-icon fa fa-times'></i></button><br>"
																					+ result.message
																					+ ': '
																					+ result.data
																					+ "</div>");
															alert(result.message
																	+ ': '
																	+ result.data);
															window.location.href = "/editutilitydata";
														},
														error : function(jqXHR,
																textStatus,
																errorThrown) {
															alert(jqXHR.status
																	+ ' '
																	+ jqXHR.responseText);
														}
													});
										}
									}
								}
							},
						});
			}
		</script>
		<script>
			$(document).ready(function() {
				ajaxGetUtilityList();
			});

			function ajaxGetUtilityList() {
				const url = '/getutility/all';
				$.getJSON(url, function(data) {
					createUtilityDataTable(data);
				});
			}

			$("#branchName-dropdown").change(function() {
				if (!$('#idFiscalYear').val()) {
					ajaxgetUtilityByByBranchName();
				} else {
					ajaxgetUtilityByFiscalAndBranch();
				}
			});
			$("#idFiscalYear").change(function() {
				if (!$('#branchName-dropdown').val()) {
					ajaxgetUtilityByFiscal();
				} else {
					ajaxgetUtilityByFiscalAndBranch();
				}
			});

			function ajaxgetUtilityByByBranchName() {
				let branchVal = $('#branchName-dropdown').val();
				$("#branchValueShow").html(': &nbsp;' + branchVal);
				const url = '/searchutility/branch/' + branchVal;
				$.getJSON(url, function(data) {
					createUtilityDataTable(data);
				});
			}

			function ajaxgetUtilityByFiscal() {
				let fiscalYearVal = $('#idFiscalYear').val();
				$("#fiscalValueShow").html(': &nbsp;' + fiscalYearVal);
				const url = '/searchutility/fiscal/' + fiscalYearVal;
				$.getJSON(url, function(data) {
					createUtilityDataTable(data);
				});
			}

			function ajaxgetUtilityByFiscalAndBranch() {
				let fiscalYearVal = $('#idFiscalYear').val();
				let branchVal = $('#branchName-dropdown').val();

				$("#fiscalValueShow").html(': &nbsp;' + fiscalYearVal);
				$("#branchValueShow").html(': &nbsp;' + branchVal);
				const url = '/getutility/branch/' + branchVal + '/'
						+ fiscalYearVal;
				$.getJSON(url, function(data) {
					createUtilityDataTable(data);
				});
			}

			function createUtilityDataTable(data) {
				var table = $('#dynamic-table')
						.DataTable(
								{
									"order" : [ 1, "desc" ],
									destroy : true,
									"data" : data,
									select : "single",
									"columns" : [

											{
												"className" : 'details-control',
												"orderable" : false,
												"data" : null,
												"defaultContent" : '',
												"render" : function() {
													return '<i class="ace-icon fa fa-angle-double-down fa-2x" title="Show details" aria-hidden="true"></i>';
												},
												width : "15px"
											},
											{
												"data" : "fiscalYear"
											},
											{
												"data" : "branchName",
												"render" : function(data, type,
														row, meta) { // render event defines the markup of the cell text 
													var a = '<a href="utility/detailpage/' + row["id"]+ '"> '
															+ row.branchName
															+ '</a>'; // row object contains the row data
													return a;
												}
											},
											{
												"data" : "month"
											},
											{
												"data" : "electricityExpenseAmount",
												render : function(data, type,
														row) {
													return currency(
															row.electricityExpenseAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "fuelExpensesTwoWheelAmount",
												render : function(data, type,
														row) {
													return currency(
															row.fuelExpensesTwoWheelAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "fuelExpensesFourWheelAmount",
												render : function(data, type,
														row) {
													return currency(
															row.fuelExpensesFourWheelAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "fuelGensetAmount",
												render : function(data, type,
														row) {
													return currency(
															row.fuelGensetAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "telephoneExpenseAmount",
												render : function(data, type,
														row) {
													return currency(
															row.telephoneExpenseAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "maintenanceExpenseAmount",
												render : function(data, type,
														row) {
													return currency(
															row.maintenanceExpenseAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "othersExpensesAmount",
												render : function(data, type,
														row) {
													return currency(
															row.othersExpensesAmount,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : "totalExpense",
												"render" : function(data, type,
														row, meta) {
													return currency(
															row.totalExpense,
															{
																useVedic : true,
																decimal : '.',
																precision : 2
															}).format();
												}
											},
											{
												"data" : null,
												"className" : 'center',
												"orderable" : false,
												"render" : function(data, type,
														row, meta) { // render event defines the markup of the cell text 
													var a = '<div class="btn-group"><a class="btn btn-xs no-border btn-round btn-success" title="Click to view details." href="/editutilitydata/' + row["id"]+ '"><i class="ace-icon fa fa-search-plus bigger-160" aria-hidden="true"></i></a></div>';
													return a;
												}
											},
											{
												"data" : null,
												"className" : 'center',
												"orderable" : false,
												"render" : function(data, type,
														row, meta) { // render event defines the markup of the cell text 
													var a = '<div class="btn-group"><a class="btn btn-xs btn-danger care_delete" title="Delete details.">&nbsp;<i class="ace-icon fa fa-trash-o bigger-160" aria-hidden="true"></i></a></div>';
													return a;
												}
											}

									],
									dom : 'Blfrtip',
									buttons : [
											{
												"extend" : "copy",
												"text" : "<i class='fa fa-copy bigger-110 pink'></i> <span class='hidden'>Copy to clipboard</span>",
												"className" : "btn btn-white btn-primary btn-bold"
											},
											{
												"extend" : "csv",
												"text" : "<i class='fa fa-file-excel-o bigger-110 blue'></i> <span class='hidden'>Export to CSV</span>",
												"className" : "btn btn-white btn-primary btn-bold"
											},
											{
												"extend" : "excel",
												"text" : "<i class='fa fa-file-excel-o bigger-110 green'></i> <span class='hidden'>Export to Excel</span>",
												"className" : "btn btn-white btn-primary btn-bold",
												"exportOptions" : {
													modifier : {
														page : 'all'
													}
												}
											},
											{
												"extend" : "pdf",
												"text" : "<i class='fa fa-file-pdf-o bigger-110 red'></i> <span class='hidden'>Export to PDF</span>",
												"className" : "btn btn-white btn-primary btn-bold",
												"exportOptions" : {
													modifier : {
														page : 'all'
													}
												}
											},
											{
												"extend" : "print",
												"text" : "<i class='fa fa-print bigger-110 grey'></i> <span class='hidden'>Print</span>",
												"className" : "btn btn-white btn-primary btn-bold",
												autoPrint : true,
												orientation : 'landscape',
												title : "Utility Expenses Details"
											} ]

								});

				// Add event listener for opening and closing details
				$('#dynamic-table tbody').on(
						'click',
						'td.details-control',
						function() {
							var tr = $(this).closest('tr');
							var tdi = tr.find("i.fa");
							var row = table.row(tr);

							if (row.child.isShown()) {
								// This row is already open - close it
								row.child.hide();
								tr.removeClass('shown');
								tdi.first().removeClass(
										'fa fa-angle-double-up fa-2x');
								tdi.first().addClass(
										'fa fa-angle-double-down fa-2x');
							} else {
								// Open this row
								row.child(format(row.data())).show();
								tr.addClass('shown');
								tdi.first().removeClass(
										'fa fa-angle-double-down fa-2x');
								tdi.first().addClass(
										'fa fa-angle-double-up fa-2x');
							}
						});

				table.on("user-select", function(e, dt, type, cell,
						originalEvent) {
					if ($(cell.node()).hasClass("details-control")) {
						e.preventDefault();
					}
				});

				function format(d) {
					// `d` is the original data object for the row
					return '<table class="table table-striped table-bordered table-hover">'
							+ '<tr>' + '<th width="25%" class="center green">'
							+ d.branchName
							+ '&nbsp;('
							+ d.fiscalYear
							+ ')'
							+ '&nbsp;'
							+ d.month
							+ '</th>'
							+ '<th width="20%" class="center">Amount (Rs.)</th>'
							+ '<th width="55%" class="center">Remarks</th>'

							+ '</tr>'
							+ '<tr>'
							+ '<td ><strong>Electricity Expenses : </strong></td>'
							+ '<td>'
							+ currency(d.electricityExpenseAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.electricityExpenseRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Fuel Expenses (Vehicle- 2 Wheeler) : </strong></td>'
							+ '<td>'
							+ currency(d.fuelExpensesTwoWheelAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.fuelExpensesTwoWheelRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Fuel Expenses (Vehicle-4 Wheeler) : </strong></td>'
							+ '<td>'
							+ currency(d.fuelExpensesFourWheelAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.fuelExpensesFourWheelRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Fuel Expenses (Genset) : </strong></td>'
							+ '<td>'
							+ currency(d.fuelGensetAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.fuelGensetRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Telephone Expenses : </strong></td>'
							+ '<td>'
							+ currency(d.telephoneExpenseAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.telephoneExpenseRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Maintenance Expenses : </strong></td>'
							+ '<td>'
							+ currency(d.maintenanceExpenseAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.maintenanceExpenseRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td ><strong>Others Expenses : </strong></td>'
							+ '<td>'
							+ currency(d.othersExpensesAmount, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</td>'
							+ '<td>'
							+ d.othersExpensesRemarks
							+ '</td>'
							+ '</tr>'

							+ '<tr>'
							+ '<td><h5><strong> Total Expenses: </strong></h5></td>'
							+ '<td><h5><strong>'
							+ currency(d.totalExpense, {
								useVedic : true,
								decimal : '.',
								symbol : 'Rs. ',
								formatWithSymbol : true,
								precision : 2
							}).format()
							+ '</strong></h5></td>'
							+ '<td></td></tr>' + '</table>';
				}

				$('#dynamic-table').on('click', 'a.care_delete', function(e) {
					e.preventDefault();
					var row_val = table.row($(this).closest('tr'));
					var data_val = row_val.data();
					updateParent(data_val.id);
				});
			}
		</script>
	</th:block>
</body>
</html>